<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>MQTT presence</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <h2 class="mb-4 text-center">{{appName}} {{ version }}</h2>
        <div class="mb-4 text-center">{{description}}</div>
        <!-- State Section -->
        <div class="card shadow-sm mb-5">
            <div class="card-body">
                <h4 class="card-title mb-3">State</h4>
                <p>MQTT connection: <strong id="mqtt_status">Loading...</strong></p>
                <p>Client ID: <strong id="client_id">Loading...</strong></p>
            </div>
        </div>


        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-4">Configuration</h4>
                <div class="row">
                    <!-- MQTT Settings -->
                    <div class="col-md-6 mb-4">
                        <h5 class="mb-3">MQTT settings</h5>

                            <div class="mb-3">
                                <label class="form-label" for="host_mqtt">Broker/Host</label>
                                <input class="form-control" type="text" id="host_mqtt" placeholder="MQTT Broker">
                            </div>    
                            <div class="mb-3">
                                <label class="form-label" for="username">Benutzername:</label>
                                <input class="form-control" type="text" id="username" placeholder="MQTT User">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="password">Password:</label>
                                <input class="form-control" type="password" id="password" placeholder="(unchanged, if empty)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="prefix">Prefix:</label>
                                <input class="form-control" type="text" id="prefix" placeholder="Prefix">
                            </div>
                    </div>
                </div>


            </div>

        </div>
        <label for="updateRate">Update-Rate:</label>
        <input type="number" id="updateRate">

        <h2>WebServer</h2>
        <label for="host">Host:</label>
        <input type="text" id="host">
        <label for="port">Port:</label>
        <input type="number" id="port">

        <h2>MQTT Broker</h2>


        <h2>Home Assistant</h2>
        <label for="device_name">Ger√§tename:</label>
        <input type="text" id="device_name">

        <div class="card shadow-sm">
            <div class="card-body">
            <h2>GPIO Einstellungen</h2>
            <div id="gpio-container"></div>
            <button onclick="addGpio()">‚ûï GPIO hinzuf√ºgen</button>
            <label for="enable_raspberryPi">Raspberry Pi aktivieren:</label>
            <input type="checkbox" id="enable_raspberryPi">
            <h2>GPIO Einstellungen</h2>
            <div id="gpio-container"></div>
        </div>
        <button onclick="updateConfig()">üíæ Speichern</button>
        <button onclick="updateConfig()">Speichern</button>
    </div>

    <script>
        let gpioCounter = 0;

        function addGpio(mode = "led", number = "", friendlyName = "") {
            let gpioContainer = document.getElementById("gpio-container");
            let div = document.createElement("div");
            div.classList.add("gpio-entry");
            div.setAttribute("data-index", gpioCounter);

            div.innerHTML = `
                <label>GPIO ${gpioCounter}</label>
                <input type="number" placeholder="Nummer" value="${number}" class="gpio-number">
                <input type="text" placeholder="Name" value="${friendlyName}" class="gpio-name">
                <select class="gpio-mode">
                    <option value="led" ${mode === "led" ? "selected" : ""}>LED</option>
                    <option value="button" ${mode === "button" ? "selected" : ""}>Button</option>
                </select>
                <button onclick="removeGpio(${gpioCounter})">‚ùå Entfernen</button>
            `;

            gpioContainer.appendChild(div);
            gpioCounter++;
        }

        function removeGpio(index) {
            document.querySelector(`[data-index='${index}']`).remove();
        }

        async function updateConfig() {
            let gpios = [];
            document.querySelectorAll(".gpio-entry").forEach(entry => {
                let number = entry.querySelector(".gpio-number").value;
                let friendlyName = entry.querySelector(".gpio-name").value;
                let mode = entry.querySelector(".gpio-mode").value;

                gpios.push({ mode, number: parseInt(number), friendly_name: friendlyName });
            });

            let newConfig = {
                updateRate: parseInt(document.getElementById("updateRate").value),
                webServer: { host: document.getElementById("host").value, port: parseInt(document.getElementById("port").value) },
                mqtt: { broker: { client_id: document.getElementById("client_id").value, host: document.getElementById("host_mqtt").value, username: document.getElementById("username").value } },
                devices: { raspberryPi: { enabled: document.getElementById("enable_raspberryPi").checked, gpios } }
            };

            

            await fetch('/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(g_config) });

            alert("Konfiguration gespeichert!");
        }

        // GPIOs aus der aktuellen Konfiguration beim Start laden
        async function fetchConfig() {
            let response = await fetch('/config');
            let config = await response.json();
            document.getElementById("updateRate").value = parseInt(config.updateRate);
            document.getElementById("host").value = config.webServer.host;
            document.getElementById("port").value = parseInt(config.webServer.port);
            document.getElementById("client_id").value = config.mqtt.broker.client_id;
            document.getElementById("host_mqtt").value = config.mqtt.broker.host;
            document.getElementById("username").value = config.mqtt.broker.username;
            document.getElementById("device_name").value = config.mqtt.homeassistant.device_name;

            config.devices.raspberryPi.gpios.forEach(gpio => {
                addGpio(gpio.mode, gpio.number, gpio.friendly_name);
            });
        }

        fetchConfig();

    </script>
</body>
</html>
